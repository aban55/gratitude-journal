const DRAFT_KEY = 'gj_draft_v1';           // draft of current entry
const ENTRIES_KEY = 'gratitudeEntries';    // already used for saved entries
const AFFIRM_KEY = 'savedAffirmations';

import { useState, useEffect, useMemo } from 'react'
import { Card, CardContent } from './ui/Card.jsx'
import { Button } from './ui/Button.jsx'
import { Textarea } from './ui/Textarea.jsx'
import { Select } from './ui/Select.jsx'
import { Slider } from './ui/Slider.jsx'
import { LineChart, Line, XAxis, YAxis, CartesianGrid, Tooltip, ResponsiveContainer } from 'recharts'

const sections = {
  'People & Relationships': [
    'Who made my life easier or better today?',
    'Which friend or family member am I grateful for â€” and why?',
    'What small act of kindness did someone show me recently?',
    'Whatâ€™s a quality in someone close to me that I admire?',
    'Who did I help or encourage today â€” and how did that feel?'
  ],
  'Self & Inner Strength': [
    'What ability or personal quality am I thankful for today?',
    'What challenge have I handled better than before?',
    'What is one thing about my body or health I appreciate?',
    'What habit or discipline am I proud of keeping?',
    'What lesson did a past mistake teach me that helps me now?'
  ],
  'Learning & Growth': [
    'What new idea or skill did I learn recently?',
    'What feedback or advice am I grateful for?',
    'What am I curious or excited to explore next?',
    'What problem am I grateful to have â€” because itâ€™s teaching me something?',
    'What book, conversation, or experience gave me insight recently?'
  ],
  'Environment & Everyday Comforts': [
    'What part of my home brings me peace or comfort?',
    'What small thing in nature caught my attention today?',
    'What simple pleasure did I enjoy â€” food, music, warmth, quiet?',
    'What modern convenience or tool makes life smoother?',
    'What moment today felt safe, calm, or peaceful?'
  ],
  'Perspective & Hope': [
    'What opportunity am I grateful to have that others may not?',
    'What am I looking forward to in the coming week?',
    'Who or what reminds me that life is bigger than my worries?',
    'How has a tough time in my life shaped who I am today?',
    'What am I thankful for that I usually take for granted?'
  ],
  'Health & Wellbeing': [
    'What part of my body served me well today?',
    'What healthy choice did I make today?',
    'How does my body show gratitude when I care for it?',
    'What signs of recovery or strength am I noticing lately?',
    'Who supports my physical or emotional health â€” and how can I appreciate them?'
  ]
}

function analyzeSentiment(text) {
  const positiveWords = ['grateful', 'happy', 'joy', 'calm', 'peace', 'love', 'thankful', 'excited', 'proud', 'hopeful']
  const negativeWords = ['tired', 'sad', 'angry', 'stressed', 'worried', 'upset', 'frustrated', 'lonely']
  let score = 0
  positiveWords.forEach(word => { if (text.toLowerCase().includes(word)) score += 1 })
  negativeWords.forEach(word => { if (text.toLowerCase().includes(word)) score -= 1 })
  if (score > 2) return 'ğŸ˜Š Positive'
  if (score > 0) return 'ğŸ™‚ Calm/Content'
  if (score === 0) return 'ğŸ˜ Neutral'
  if (score < 0) return 'ğŸ˜Ÿ Stressed/Low'
}

function getAffirmation(sentiment) {
  const affirmations = {
    'ğŸ˜Š Positive': [
      'Keep nurturing your joy; itâ€™s contagious.',
      'You are radiating warmth and balance today.',
      'Happiness expands when you acknowledge it â€” well done.'
    ],
    'ğŸ™‚ Calm/Content': [
      'Peace is your quiet strength; cherish it.',
      'You are centered and composed â€” keep flowing with grace.',
      'Tranquility is the sign of inner growth; honor it.'
    ],
    'ğŸ˜ Neutral': [
      'Even neutral days are steps forward â€” awareness itself is growth.',
      'Stillness allows new gratitude to form â€” stay open.',
      'Your calm presence is your power today.'
    ],
    'ğŸ˜Ÿ Stressed/Low': [
      'Breathe â€” difficult moments are teachers in disguise.',
      'This feeling will pass; youâ€™ve overcome tougher days.',
      'Strength grows quietly through resilience â€” youâ€™re doing fine.'
    ]
  }
  const options = affirmations[sentiment] || ['Keep showing up â€” it matters more than you know.']
  return options[Math.floor(Math.random() * options.length)]
}

export default function App() {
  const [section, setSection] = useState('People & Relationships')
  const [question, setQuestion] = useState('')
  const [entry, setEntry] = useState('')
  const [savedEntries, setSavedEntries] = useState([])
  const [savedAffirmations, setSavedAffirmations] = useState([])
  const [mood, setMood] = useState(5)
  const [view, setView] = useState('journal') // journal | summary | affirmations

  useEffect(() => {
    const stored = localStorage.getItem('gratitudeEntries')
    if (stored) setSavedEntries(JSON.parse(stored))
    const storedAffirmations = localStorage.getItem('savedAffirmations')
    if (storedAffirmations) setSavedAffirmations(JSON.parse(storedAffirmations))
  }, [])

  useEffect(() => {
    localStorage.setItem('gratitudeEntries', JSON.stringify(savedEntries))
    localStorage.setItem('savedAffirmations', JSON.stringify(savedAffirmations))
  }, [savedEntries, savedAffirmations])

  const handleSave = () => {
    if (question && entry.trim()) {
      const sentiment = analyzeSentiment(entry)
      setSavedEntries([...savedEntries, { date: new Date().toLocaleDateString(), section, question, entry, mood, sentiment }])
      setEntry('')
      setQuestion('')
      setMood(5)
    }
  }

  const handleExport = () => {
    const text = savedEntries.map(e => `${e.date} â€” ${e.section}\nMood: ${e.mood}/10\nSentiment: ${e.sentiment}\nQ: ${e.question}\nA: ${e.entry}\n`).join('\n-------------------\n')
    const blob = new Blob([text], { type: 'text/plain' })
    const link = document.createElement('a')
    link.href = URL.createObjectURL(blob)
    link.download = 'Gratitude_Journal.txt'
    link.click()
  }

  const handleSaveAffirmation = (quote) => {
    const exists = savedAffirmations.some(a => a.quote === quote)
    if (!exists) {
      setSavedAffirmations([...savedAffirmations, { quote, date: new Date().toLocaleDateString() }])
    }
  }

  useEffect(() => {
    // 9 PM reminder
    const now = new Date()
    const reminderTime = new Date()
    reminderTime.setHours(21, 0, 0, 0)
    const timeToReminder = reminderTime.getTime() - now.getTime()
    if (timeToReminder > 0) {
      const timer = setTimeout(() => {
        alert('ğŸ•¯ Time for your daily gratitude reflection!')
      }, timeToReminder)
      return () => clearTimeout(timer)
    }
  }, [])

  const summary = useMemo(() => {
    if (!savedEntries.length) return null
    const last10 = savedEntries.slice(-10)
    const last7 = savedEntries.slice(-7)
    const avgMood = (last7.reduce((acc, e) => acc + e.mood, 0) / last7.length).toFixed(1)
    const sectionCounts = last7.reduce((acc, e) => {
      acc[e.section] = (acc[e.section] || 0) + 1
      return acc
    }, {})
    const topSections = Object.entries(sectionCounts).sort((a,b)=>b[1]-a[1]).slice(0,3).map(([k])=>k)
    const bestDays = last7.slice().sort((a,b)=>b.mood-a.mood).slice(0,3).map(e=>`${e.date} (${e.mood}/10) â€” ${e.section}`)
    const sentimentSummary = last10.reduce((acc,e)=>{ acc[e.sentiment]=(acc[e.sentiment]||0)+1; return acc },{})
    const topSentiment = Object.entries(sentimentSummary).sort((a,b)=>b[1]-a[1])[0]?.[0] || 'â€”'
    const leastFocused = Object.entries(sectionCounts).sort((a,b)=>a[1]-b[1]).slice(0,2).map(([k])=>k)
    const dailyAffirmation = getAffirmation(topSentiment)
    return { avgMood, topSections, bestDays, sentimentSummary, topSentiment, leastFocused, dailyAffirmation }
  }, [savedEntries])

  return (
    <div className="p-6 space-y-4 max-w-3xl mx-auto">
      <h1 className="text-3xl font-bold text-center mb-2">ğŸŒ¿ Daily Gratitude Journal</h1>
      <p className="text-center text-gray-600 mb-4">Save short reflections daily. Track mood & insights weekly.</p>

      <div className="flex justify-center gap-2 mb-4">
        <Button variant={view === 'journal' ? 'default' : 'outline'} onClick={() => setView('journal')}>Journal</Button>
        <Button variant={view === 'summary' ? 'default' : 'outline'} onClick={() => setView('summary')}>Weekly Summary</Button>
        <Button variant={view === 'affirmations' ? 'default' : 'outline'} onClick={() => setView('affirmations')}>Saved Affirmations</Button>
      </div>

      {view === 'journal' && (
        <>
          <Card>
            <CardContent className="space-y-4">
              <Select
                value={section}
                onChange={(val)=>{ setSection(val); setQuestion('') }}
                options={Object.keys(sections)}
              />
              <Select
                value={question}
                onChange={setQuestion}
                options={['', ...sections[section]]}
                placeholder="Pick a gratitude question"
              />

              {question && (
                <>
                  <p className="text-sm text-gray-600">{question}</p>
                  <Textarea placeholder="Write your reflection here..." value={entry} onChange={(e)=>setEntry(e.target.value)} />
                  <div className="space-y-2">
                    <p className="text-sm">Mood for today: {mood}/10</p>
                    <Slider min={1} max={10} step={1} value={[mood]} onChange={(v)=>setMood(v[0])} />
                  </div>
                  <Button onClick={handleSave}>Save Entry</Button>
                </>
              )}
            </CardContent>
          </Card>

          {savedEntries.length > 0 && (
            <div className="space-y-3 mt-6">
              <div className="flex justify-between items-center">
                <h2 className="text-xl font-semibold">ğŸ•Š Past Entries</h2>
                <Button onClick={handleExport} variant="outline">Export All</Button>
              </div>
              {savedEntries.map((e, i) => (
                <Card key={i}>
                  <CardContent>
                    <p className="text-sm text-gray-500">{e.date} â€” {e.section}</p>
                    <p className="text-xs text-gray-400">Mood: {e.mood}/10 | Sentiment: {e.sentiment}</p>
                    <p className="font-medium mt-1">{e.question}</p>
                    <p className="mt-2 whitespace-pre-wrap">{e.entry}</p>
                  </CardContent>
                </Card>
              ))}
            </div>
          )}
        </>
      )}

      {view === 'summary' && summary && (
        <Card>
          <CardContent className="space-y-4">
            <h2 className="text-2xl font-semibold">ğŸ“Š Weekly Summary & Insights</h2>
            <p>Average Mood (last 7 entries): <strong>{summary.avgMood}/10</strong></p>

            <ResponsiveContainer width="100%" height={250}>
              <LineChart data={savedEntries.map(e=>({ date: e.date, mood: e.mood }))}>
                <CartesianGrid strokeDasharray="3 3" />
                <XAxis dataKey="date" />
                <YAxis domain={[0,10]} />
                <Tooltip />
                <Line type="monotone" dataKey="mood" stroke="#16a34a" strokeWidth={2} dot={true} />
              </LineChart>
            </ResponsiveContainer>

            <div>
              <p className="font-medium">Top 3 Gratitude Themes:</p>
              <ul className="list-disc list-inside">
                {summary.topSections.map((sec, i) => <li key={i}>{sec}</li>)}
              </ul>
            </div>

            <div>
              <p className="font-medium">Top 3 Positive Days:</p>
              <ul className="list-disc list-inside">
                {summary.bestDays.map((d, i) => <li key={i}>{d}</li>)}
              </ul>
            </div>

            <div>
              <p className="font-medium">ğŸ§  Reflection Insights (last 10 entries):</p>
              <p>Dominant Sentiment: <strong>{summary.topSentiment}</strong></p>
              <ul className="list-disc list-inside">
                {Object.entries(summary.sentimentSummary).map(([tone, count], i) => (
                  <li key={i}>{tone}: {count} entries</li>
                ))}
              </ul>
            </div>

            <div>
              <p className="font-medium">ğŸŒˆ Positive Focus for Next Week:</p>
              <p>Based on recent patterns, consider writing more about:</p>
              <ul className="list-disc list-inside">
                {summary.leastFocused.map((sec, i) => <li key={i}>{sec}</li>)}
              </ul>
              <p className="text-sm text-gray-500 mt-2">These areas appeared less frequently in your reflections and may bring new emotional balance if explored.</p>
            </div>

            <div className="bg-green-50 border-l-4 border-green-400 p-4 rounded">
              <p className="font-semibold text-green-800">ğŸŒ Daily Affirmation:</p>
              <p className="text-green-700 italic">â€œ{summary.dailyAffirmation}â€</p>
              <Button variant="outline" className="mt-2" onClick={() => handleSaveAffirmation(summary.dailyAffirmation)}>
                Save to My Favorites
              </Button>
            </div>
          </CardContent>
        </Card>
      )}

      {view === 'affirmations' && (
        <Card>
          <CardContent className="space-y-4">
            <h2 className="text-2xl font-semibold">ğŸ’– My Saved Affirmations</h2>
            {savedAffirmations.length === 0 ? (
              <p className="text-gray-600">No saved affirmations yet. Save ones that inspire you from the Weekly Summary view.</p>
            ) : (
              <ul className="list-disc list-inside space-y-2">
                {savedAffirmations.map((a, i) => (
                  <li key={i}>
                    <span className="italic">â€œ{a.quote}â€</span>
                    <p className="text-xs text-gray-500">Saved on {a.date}</p>
                  </li>
                ))}
              </ul>
            )}
          </CardContent>
        </Card>
      )}
    </div>
  )
}
